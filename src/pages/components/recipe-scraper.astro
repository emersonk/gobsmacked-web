---
// src/pages/recipe-scraper.astro
import BaseLayout from "@/layouts/BaseLayout.astro";
import { databases } from "@/lib/appwrite";
import { ID, Query } from "appwrite";
import { fetchRecipe } from "@/scripts/api";

let error: string | null = null;

// Server-side form handling
if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const recipeUrl = formData.get("recipeUrl");

    if (typeof recipeUrl !== "string") {
      throw new Error("Recipe URL must be a string");
    }

    // TODO generate a hash from the URL and use that as the slug

    // Check if the URL already exists in the DB
    const r = await databases.listDocuments(
      import.meta.env.PUBLIC_APPWRITE_DATABASE_ID,
      import.meta.env.PUBLIC_APPWRITE_COLLECTION_ID,
      [
        Query.equal("OriginalURL", recipeUrl)
      ]
    );

    if (r.total === 1){
      // Load recipe from database and redirect to page
    } else {
      // Format recipe, save to database,
      const formattedRecipe = await fetchRecipe(recipeUrl);

      const data = {
        OriginalURL: recipeUrl,
        Ingredients: formattedRecipe.ingredients,
        Steps: formattedRecipe.steps,
      };

      const results = await databases.createDocument(
        import.meta.env.PUBLIC_APPWRITE_DATABASE_ID,
        import.meta.env.PUBLIC_APPWRITE_COLLECTION_ID,
        ID.unique(),
        data
      );
    }

    // TODO this will send it to the recipe display page which will then render the recipe from the database
    // TODO pass the ingredients & steps to the new page so that it doesn't have to go to database
    return Astro.redirect(`/components/slugTest`);
  } catch (err) {
    error = `Failed to process recipe: ${err instanceof Error ? err.message : "Unknown error"}`;
  }
}
---

<BaseLayout>
  <div class="container">
    <h1>Recipe Scraper</h1>

    <form method="POST" class="form">
      <input
        type="url"
        name="recipeUrl"
        class="input"
        placeholder="Enter recipe URL"
        required
      />
      <button type="submit" class="button">Scrape Recipe</button>
    </form>

    {error && <div class="error">{error}</div>}
  </div>
</BaseLayout>
