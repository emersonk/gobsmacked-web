---
// src/pages/recipe-scraper.astro
import BaseLayout from "@/layouts/BaseLayout.astro";
import { databases } from "@/lib/appwrite";
import { ID } from 'appwrite';

let error: string | null = null;

// Server-side form handling
if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const recipeUrl = formData.get("recipeUrl");

    if (typeof recipeUrl !== "string") {
      throw new Error("Recipe URL must be a string");
    }

    const data = {
      OriginalURL: recipeUrl,
      Ingredients: null,
      Steps: null
    };

    const results = await databases.createDocument(
      import.meta.env.PUBLIC_APPWRITE_DATABASE_ID,
      import.meta.env.PUBLIC_APPWRITE_COLLECTION_ID,
      ID.unique(),
      data
    );

    console.log(recipeUrl);
    return Astro.redirect("/components/recipe-scraper");
  } catch (err) {
    error = `Failed to process recipe: ${err instanceof Error ? err.message : "Unknown error"}`;
  }
}
---

<BaseLayout>
  <div class="container">
    <h1>Recipe Scraper</h1>

    <form method="POST" class="form">
      <input
        type="url"
        name="recipeUrl"
        class="input"
        placeholder="Enter recipe URL"
        required
      />
      <button type="submit" class="button">Scrape Recipe</button>
    </form>

    {error && <div class="error">{error}</div>}
  </div>
</BaseLayout>
